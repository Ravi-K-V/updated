<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EyeSpecialist.ai - Advanced Clinical Decision Support for Optometry</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #FAFAFA;
            min-height: 100vh;
        }

        .header {
            background-color: #0A3D62;
            color: white;
            padding: 1.5rem;
        }

        .header-content {
            max-width: 64rem;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .header-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin: 0;
        }

        .header-subtitle {
            color: #bfdbfe;
            margin: 0;
            font-size: 0.875rem;
        }

        .assessment-header .header-title {
            font-size: 1.25rem;
        }

        .back-button {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #bfdbfe;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 0.875rem;
            padding: 0.5rem;
            border-radius: 0.25rem;
            transition: background-color 0.2s;
        }

        .back-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .main-content {
            max-width: 64rem;
            margin: 0 auto;
            padding: 1.5rem;
        }

        .card {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
            padding: 2rem;
            margin-bottom: 1.5rem;
        }

        .welcome-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: #1C1C1C;
        }

        .welcome-description {
            color: #6b7280;
            margin-bottom: 1.5rem;
        }

        .disclaimer {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 2rem;
            padding: 0.75rem;
            background-color: #fef3c7;
            border-radius: 0.25rem;
            border-left: 4px solid #f59e0b;
        }

        .condition-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }

        .condition-card {
            background: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
        }

        .condition-card:hover {
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .condition-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .condition-title {
            font-weight: 600;
            font-size: 1.125rem;
            color: #1C1C1C;
            margin: 0;
        }

        .condition-description {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.75rem;
        }

        .condition-pathways {
            font-size: 0.75rem;
            color: #6b7280;
        }

        .progress-container {
            background: white;
            border-bottom: 1px solid #e5e7eb;
        }

        .progress-content {
            max-width: 64rem;
            margin: 0 auto;
            padding: 1rem;
        }

        .progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }

        .progress-bar {
            width: 100%;
            background-color: #e5e7eb;
            border-radius: 9999px;
            height: 0.5rem;
        }

        .progress-fill {
            height: 0.5rem;
            border-radius: 9999px;
            transition: width 0.3s;
            background-color: #0A3D62;
        }

        .question-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: #1C1C1C;
        }

        .question-subtitle {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 1rem;
            font-style: italic;
        }

        .options-container {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .option-button {
            width: 100%;
            padding: 1rem;
            text-align: left;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1rem;
        }

        .option-button:hover {
            background-color: #eff6ff;
            border-color: #3b82f6;
        }

        .red-flags-box {
            background-color: #fef2f2;
            border: 1px solid #fca5a5;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .red-flags-title {
            font-weight: 600;
            color: #dc2626;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .red-flags-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .red-flag-item {
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            color: #7f1d1d;
            margin-bottom: 0.25rem;
            font-size: 0.875rem;
        }

        .clinical-note {
            background-color: #eff6ff;
            border-left: 4px solid #0A3D62;
            padding: 1rem;
            margin-top: 1rem;
            font-size: 0.875rem;
            color: #374151;
        }

        .navigation-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            justify-content: space-between;
        }

        .back-tab {
            background: white;
            border: 2px solid #0A3D62;
            color: #0A3D62;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .back-tab:hover {
            background-color: #0A3D62;
            color: white;
        }

        .back-tab:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .back-tab:disabled:hover {
            background: white;
            color: #0A3D62;
        }

        .hidden {
            display: none !important;
        }

        .icon {
            width: 20px;
            height: 20px;
            stroke: currentColor;
            stroke-width: 2;
            fill: none;
        }

        .eye-icon {
            width: 32px;
            height: 32px;
        }

        /* Results Screen Styles */
        .recommendation-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .urgency-icon {
            padding: 0.5rem;
            border-radius: 50%;
            color: white;
        }

        .recommendation-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1C1C1C;
            margin: 0;
        }

        .recommendation-subtitle {
            color: #6b7280;
            margin: 0;
        }

        .reasoning-box {
            background-color: #f9fafb;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .reasoning-text {
            color: #374151;
            margin: 0;
        }

        .section-title {
            font-weight: 600;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #1C1C1C;
        }

        .next-steps-box {
            background-color: #eff6ff;
            padding: 1rem;
            border-radius: 0.5rem;
            border-left: 4px solid #0A3D62;
        }

        .next-steps-text {
            color: #374151;
            margin: 0;
        }

        .management-box {
            background-color: #f0fdf4;
            padding: 1rem;
            border-radius: 0.5rem;
            border-left: 4px solid #22c55e;
            margin-bottom: 1rem;
        }

        .management-title {
            font-weight: 600;
            color: #166534;
            margin-bottom: 0.5rem;
        }

        .management-list {
            margin: 0;
            padding: 0;
            list-style: none;
        }

        .management-item {
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .secondary-button {
            flex: 1;
            background: white;
            border: 1px solid #d1d5db;
            color: #374151;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .secondary-button:hover {
            background-color: #f9fafb;
        }

        .primary-button {
            flex: 1;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            border: none;
            background-color: #0A3D62;
            transition: opacity 0.2s;
        }

        .primary-button:hover {
            opacity: 0.9;
        }

        .section-margin {
            margin-bottom: 1.5rem;
        }

        /* MECS Eligibility Styles */
        .mecs-eligible {
            background-color: #dcfce7;
            padding: 0.5rem;
            border-radius: 0.25rem;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            color: #166534;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .mecs-not-eligible {
            background-color: #fee2e2;
            padding: 0.5rem;
            border-radius: 0.25rem;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            color: #991b1b;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .practice-management-box {
            background-color: #e0f2fe;
            padding: 1rem;
            border-radius: 0.5rem;
            border-left: 4px solid #0284c7;
            margin-bottom: 1rem;
        }

        /* Severity Score Styles */
        .severity-indicator {
            margin-top: 1rem;
            padding: 0.75rem;
            background-color: #f3f4f6;
            border-radius: 0.5rem;
            font-size: 0.875rem;
        }

        .severity-score {
            font-weight: 600;
            color: #1C1C1C;
            margin-bottom: 0.25rem;
        }

        .severity-bar {
            width: 100%;
            height: 0.5rem;
            background-color: #e5e7eb;
            border-radius: 0.25rem;
            margin-top: 0.5rem;
            position: relative;
            overflow: hidden;
        }

        .severity-fill {
            height: 100%;
            border-radius: 0.25rem;
            transition: width 0.5s ease;
            background: linear-gradient(to right, #22c55e, #FFC300, #dc3545);
        }

        /* Medication Box Styles */
        .medications-box {
            background-color: #fef3c7;
            padding: 1rem;
            border-radius: 0.5rem;
            border-left: 4px solid #f59e0b;
            margin-bottom: 1rem;
        }

        .medications-title {
            font-weight: 600;
            color: #92400e;
            margin-bottom: 0.5rem;
        }

        /* Forms and Safety Lists */
        .forms-list, .safety-list {
            margin: 0;
            padding: 0;
            list-style: none;
        }

        .forms-item, .safety-item {
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        /* GOS18 Form Styles */
        .gos18-container {
            margin-top: 2rem;
            padding: 1rem;
            background: white;
            border: 2px solid #0A3D62;
            border-radius: 0.5rem;
            position: relative;
            max-width: 100%;
            overflow-x: auto;
        }

        @media (min-width: 768px) {
            .gos18-container {
                padding: 2rem;
            }
        }

        .gos18-header {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #0A3D62;
        }

        @media (min-width: 768px) {
            .gos18-header {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }

        .gos18-title {
            font-size: 1.25rem;
            font-weight: bold;
            color: #0A3D62;
        }

        @media (min-width: 768px) {
            .gos18-title {
                font-size: 1.5rem;
            }
        }

        .gos18-subtitle {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }

        @media (min-width: 768px) {
            .gos18-subtitle {
                font-size: 0.875rem;
            }
        }

        .gos18-close {
            background: #dc2626;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.25rem;
            cursor: pointer;
            font-size: 0.875rem;
            transition: background-color 0.2s;
            align-self: flex-start;
        }

        .gos18-close:hover {
            background-color: #b91c1c;
        }

        .gos18-form {
            font-size: 0.75rem;
            font-family: 'Arial', sans-serif;
        }

        @media (min-width: 768px) {
            .gos18-form {
                font-size: 0.875rem;
            }
        }

        .gos18-form table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
            background: white;
            display: block;
            overflow-x: auto;
        }

        .gos18-form th,
        .gos18-form td {
            border: 1px solid #333;
            padding: 0.25rem;
            text-align: left;
            vertical-align: middle;
            min-width: 60px;
        }

        @media (min-width: 768px) {
            .gos18-form th,
            .gos18-form td {
                padding: 0.5rem;
            }
        }

        .gos18-form th {
            background-color: #f3f4f6;
            font-weight: 600;
        }

        .gos18-form input[type="text"],
        .gos18-form input[type="date"],
        .gos18-form input[type="tel"],
        .gos18-form input[type="email"],
        .gos18-form input[type="time"],
        .gos18-form textarea {
            width: calc(100% - 0.5rem);
            padding: 0.25rem;
            border: 1px solid #d1d5db;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-family: 'Arial', sans-serif;
            background: white;
        }

        @media (min-width: 768px) {
            .gos18-form input[type="text"],
            .gos18-form input[type="date"],
            .gos18-form input[type="tel"],
            .gos18-form input[type="email"],
            .gos18-form input[type="time"],
            .gos18-form textarea {
                font-size: 0.875rem;
            }
        }

        .gos18-form textarea {
            resize: vertical;
            min-height: 60px;
        }

        @media (min-width: 768px) {
            .gos18-form textarea {
                min-height: 80px;
            }
        }

        .gos18-form input[type="checkbox"] {
            margin-right: 0.25rem;
            width: 14px;
            height: 14px;
            vertical-align: middle;
        }

        @media (min-width: 768px) {
            .gos18-form input[type="checkbox"] {
                margin-right: 0.5rem;
                width: 16px;
                height: 16px;
            }
        }

        .gos18-section {
            margin-bottom: 1rem;
        }

        @media (min-width: 768px) {
            .gos18-section {
                margin-bottom: 1.5rem;
            }
        }

        .gos18-section-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            background-color: #e5e7eb;
            padding: 0.375rem;
            border: 1px solid #333;
            text-align: center;
            font-size: 0.875rem;
        }

        @media (min-width: 768px) {
            .gos18-section-title {
                padding: 0.5rem;
                font-size: 1rem;
            }
        }

        .gos18-responsive-table {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-bottom: 1rem;
        }

        .gos18-form .prescription-table {
            min-width: 600px;
        }

        @media (max-width: 767px) {
            .gos18-form td[colspan="6"] {
                display: block;
                width: 100%;
            }
            
            .gos18-form td[rowspan] {
                display: block;
                width: 100%;
                border-bottom: none;
            }
        }

        .gos18-checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin: 0.5rem 0;
        }

        .gos18-checkbox-item {
            display: flex;
            align-items: center;
            min-width: 150px;
            margin-bottom: 0.25rem;
        }

        @media (max-width: 767px) {
            .gos18-checkbox-item {
                min-width: 100%;
            }
        }

        .gos18-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #e5e7eb;
        }

        .gos18-button {
            flex: 1;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .gos18-download {
            background-color: #3b82f6;
            color: white;
            border: none;
        }

        .gos18-download:hover {
            background-color: #2563eb;
        }

        .gos18-email {
            background-color: #10b981;
            color: white;
            border: none;
        }

        .gos18-email:hover {
            background-color: #059669;
        }

        .gos18-toggle {
            background-color: #6366f1;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            margin-top: 1rem;
            width: 100%;
            font-weight: 500;
            transition: all 0.2s;
        }

        .gos18-toggle:hover {
            background-color: #4f46e5;
        }

        @media print {
            .gos18-close,
            .gos18-actions,
            .gos18-toggle,
            .action-buttons,
            .back-button {
                display: none !important;
            }
        }
    </style>
    <!-- Add jsPDF library for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
    <!-- Welcome Screen -->
    <div id="welcome-screen">
        <div class="header">
            <div class="header-content">
                <div class="header-left">
                    <svg class="eye-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                    <div>
                        <h1 class="header-title">EyeSpecialist.ai</h1>
                        <p class="header-subtitle">Advanced clinical decision support for optometry practice</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="card">
                <h2 class="welcome-title">Welcome. Select the presenting condition for clinical guidance.</h2>
                <p class="welcome-description">
                    This advanced tool provides evidence-based triage pathways based on MECS, WOPEC, MEH, NHS and College of Optometrists guidelines. 
                    Each pathway includes MECS eligibility, management protocols, appropriate referral pathways and billing guidance for optometry practice.
                </p>
                <p class="disclaimer">
                    <strong>Clinical Notice:</strong> This tool incorporates MECS/PEARS pathways, NHS referral criteria, and College of Optometrists guidance. 
                    Always use your clinical judgement and consider patient-specific factors. Document all clinical decisions appropriately.
                </p>
            </div>

            <div class="condition-grid" id="condition-grid">
                <!-- Conditions will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Assessment Screen -->
    <div id="assessment-screen" class="hidden">
        <div class="header assessment-header">
            <div class="header-content">
                <div class="header-left">
                    <svg class="eye-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                    <div>
                        <h1 class="header-title">EyeSpecialist.ai</h1>
                        <p class="header-subtitle" id="assessment-subtitle">Clinical Assessment</p>
                    </div>
                </div>
                <button class="back-button" onclick="startOver()">
                    <svg class="icon" viewBox="0 0 24 24">
                        <line x1="19" y1="12" x2="5" y2="12"></line>
                        <polyline points="12,19 5,12 12,5"></polyline>
                    </svg>
                    Start Over
                </button>
            </div>
        </div>

        <div class="progress-container">
            <div class="progress-content">
                <div class="progress-text">
                    <span id="progress-text">Question 1 of 6</span>
                    <span id="progress-percent">17% Complete</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="red-flags-box hidden" id="red-flags-box">
                <h3 class="red-flags-title">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"></path>
                        <line x1="12" y1="9" x2="12" y2="13"></line>
                        <line x1="12" y1="17" x2="12.01" y2="17"></line>
                    </svg>
                    Red Flags for This Condition
                </h3>
                <ul class="red-flags-list" id="red-flags-list">
                    <!-- Red flags will be populated dynamically -->
                </ul>
            </div>

            <div class="card">
                <h2 class="question-title" id="question-title">Loading question...</h2>
                <p class="question-subtitle hidden" id="question-subtitle"></p>

                <div id="question-options">
                    <!-- Question options will be populated by JavaScript -->
                </div>

                <div class="clinical-note hidden" id="clinical-note"></div>

                <div class="navigation-buttons" id="navigation-buttons">
                    <button class="back-tab" id="back-button" onclick="previousQuestion()" disabled>
                        <svg class="icon" viewBox="0 0 24 24">
                            <line x1="19" y1="12" x2="5" y2="12"></line>
                            <polyline points="12,19 5,12 12,5"></polyline>
                        </svg>
                        Back
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Screen -->
    <div id="results-screen" class="hidden">
        <div class="header assessment-header">
            <div class="header-content">
                <div class="header-left">
                    <svg class="eye-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                    <div>
                        <h1 class="header-title">EyeSpecialist.ai</h1>
                        <p class="header-subtitle">Clinical Recommendation</p>
                    </div>
                </div>
                <button class="back-button" onclick="startOver()">
                    <svg class="icon" viewBox="0 0 24 24">
                        <line x1="19" y1="12" x2="5" y2="12"></line>
                        <polyline points="12,19 5,12 12,5"></polyline>
                    </svg>
                    New Assessment
                </button>
            </div>
        </div>

        <div class="main-content">
            <div class="card">
                <div class="recommendation-header">
                    <div class="urgency-icon" id="urgency-icon">
                        <!-- Icon will be populated by JavaScript -->
                    </div>
                    <div>
                        <h2 class="recommendation-title" id="recommendation-title">Referral</h2>
                        <p class="recommendation-subtitle" id="recommendation-subtitle">Condition</p>
                    </div>
                </div>

                <div class="reasoning-box">
                    <p class="reasoning-text" id="reasoning-text">Reasoning will appear here</p>
                </div>

                <div class="severity-indicator" id="severity-indicator">
                    <div class="severity-score" id="severity-score">Clinical Severity Score: 0</div>
                    <div class="severity-bar">
                        <div class="severity-fill" id="severity-fill"></div>
                    </div>
                </div>

                <div class="section-margin">
                    <h3 class="section-title">
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10-4.477 10-10 10zm-1-11v6h2v-6h-2zm0-4v2h2V7h-2z"></path>
                        </svg>
                        Optometry Practice Management
                    </h3>
                    <div class="practice-management-box">
                        <div id="mecs-eligibility">
                            <!-- MECS eligibility will be populated -->
                        </div>
                    </div>
                </div>

                <div class="section-margin">
                    <h3 class="section-title">
                        <svg class="icon" viewBox="0 0 24 24">
                            <polyline points="9,18 15,12 9,6"></polyline>
                        </svg>
                        Referral Pathway
                    </h3>
                    <div class="next-steps-box">
                        <p class="next-steps-text" id="next-steps-text">Next steps will appear here</p>
                    </div>
                </div>

                <div class="section-margin">
                    <h3 class="section-title">
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                        </svg>
                        Management Protocol
                    </h3>
                    <div class="management-box">
                        <h4 class="management-title">Immediate Management</h4>
                        <ul class="management-list" id="immediate-management">
                            <!-- Management steps will be populated by JavaScript -->
                        </ul>
                    </div>
                    <div class="medications-box" id="medications-box">
                        <h4 class="medications-title">Medications</h4>
                        <ul class="management-list" id="medications-list">
                            <!-- Medications will be populated by JavaScript -->
                        </ul>
                    </div>
                </div>

                <div class="section-margin">
                    <h3 class="section-title">
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path>
                            <polyline points="14,2 14,8 20,8"></polyline>
                        </svg>
                        Documentation Required
                    </h3>
                    <ul class="forms-list" id="forms-list">
                        <!-- Forms will be populated by JavaScript -->
                    </ul>
                </div>

                <div class="section-margin">
                    <h3 class="section-title">
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                        </svg>
                        Safety-Netting Advice
                    </h3>
                    <ul class="safety-list" id="safety-list">
                        <!-- Safety netting advice will be populated by JavaScript -->
                    </ul>
                </div>
            </div>

            <!-- GOS18 Form Toggle Button -->
            <button class="gos18-toggle" onclick="toggleGOS18Form()">
                <svg class="icon" viewBox="0 0 24 24" style="display: inline-block; margin-right: 0.5rem;">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                </svg>
                Generate GOS18 Referral Form
            </button>

            <!-- GOS18 Form Container -->
            <div id="gos18-form-container" class="gos18-container hidden">
                <div class="gos18-header">
                    <div>
                        <h3 class="gos18-title">GOS 18</h3>
                        <p class="gos18-subtitle">Referral/Notification (Always at optometrist)</p>
                        <p class="gos18-subtitle">Please contact the patient if they do not contact you or do not attend</p>
                    </div>
                    <button class="gos18-close" onclick="hideGOS18Form()">✕ Close</button>
                </div>

                <form id="gos18-form" class="gos18-form">
                    <!-- Patient Details Section -->
                    <div class="gos18-section">
                        <div class="gos18-section-title">CONSULTATION DATE / Patient Details</div>
                        <table>
                            <tr>
                                <td><strong>Title:</strong></td>
                                <td><input type="text" name="title" placeholder="Mr/Mrs/Miss/Ms/Other"></td>
                                <td><strong>DoB:</strong></td>
                                <td><input type="date" name="dob"></td>
                                <td rowspan="3"><strong>Address:</strong></td>
                                <td rowspan="3"><textarea name="address" rows="3"></textarea></td>
                            </tr>
                            <tr>
                                <td><strong>Surname:</strong></td>
                                <td><input type="text" name="surname"></td>
                                <td><strong>Tel (H):</strong></td>
                                <td><input type="tel" name="telHome"></td>
                            </tr>
                            <tr>
                                <td><strong>First Names:</strong></td>
                                <td><input type="text" name="firstName"></td>
                                <td><strong>Tel (M):</strong></td>
                                <td><input type="tel" name="telMobile"></td>
                            </tr>
                            <tr>
                                <td colspan="6">
                                    <strong>Other:</strong> <input type="text" name="other" style="width: 90%;">
                                </td>
                            </tr>
                            <tr>
                                <td colspan="6">
                                    <strong>Post Code:</strong> <input type="text" name="postcode" style="width: 200px;">
                                </td>
                            </tr>
                        </table>
                    </div>

                    <!-- GP Details Section -->
                    <div class="gos18-section">
                        <div class="gos18-section-title">GP Details / Optometrist Details</div>
                        <table>
                            <tr>
                                <td><strong>Name Address:</strong></td>
                                <td><input type="text" name="gpName"></td>
                                <td><strong>Name Address:</strong></td>
                                <td><input type="text" name="optName"></td>
                            </tr>
                            <tr>
                                <td><strong>E-Mail:</strong></td>
                                <td><input type="email" name="gpEmail"></td>
                                <td><strong>E-Mail:</strong></td>
                                <td><input type="email" name="optEmail"></td>
                            </tr>
                            <tr>
                                <td><strong>Tel:</strong></td>
                                <td><input type="tel" name="gpTel"></td>
                                <td><strong>Tel:</strong></td>
                                <td><input type="tel" name="optTel"></td>
                            </tr>
                        </table>
                    </div>

                    <!-- Latest Spectacle Prescription Section -->
                    <div class="gos18-section">
                        <div class="gos18-section-title">Latest Spectacle Prescription</div>
                        <div class="gos18-responsive-table">
                            <table class="prescription-table">
                                <thead>
                                    <tr>
                                        <th>Rx</th>
                                        <th>Vision</th>
                                        <th>Sph</th>
                                        <th>Cyl</th>
                                        <th>Axis</th>
                                        <th>VA</th>
                                        <th>Dist. Prism PH Acuity</th>
                                        <th>Add</th>
                                        <th>Nr. Prism</th>
                                        <th>Near VA</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>RE</td>
                                        <td><input type="text" name="reVision"></td>
                                        <td><input type="text" name="reSph"></td>
                                        <td><input type="text" name="reCyl"></td>
                                        <td><input type="text" name="reAxis"></td>
                                        <td><input type="text" name="reVA"></td>
                                        <td><input type="text" name="reDistPrism"></td>
                                        <td><input type="text" name="reAdd"></td>
                                        <td><input type="text" name="reNrPrism"></td>
                                        <td><input type="text" name="reNearVA"></td>
                                    </tr>
                                    <tr>
                                        <td>LE</td>
                                        <td><input type="text" name="leVision"></td>
                                        <td><input type="text" name="leSph"></td>
                                        <td><input type="text" name="leCyl"></td>
                                        <td><input type="text" name="leAxis"></td>
                                        <td><input type="text" name="leVA"></td>
                                        <td><input type="text" name="leDistPrism"></td>
                                        <td><input type="text" name="leAdd"></td>
                                        <td><input type="text" name="leNrPrism"></td>
                                        <td><input type="text" name="leNearVA"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Mydriasis and IOP Section -->
                    <div class="gos18-section">
                        <table>
                            <tr>
                                <td colspan="3" style="text-align: center;"><strong>Mydriasis</strong></td>
                                <td colspan="3" style="text-align: center;"><strong>Intraocular Pressure (IOP)</strong></td>
                            </tr>
                            <tr>
                                <td>Eye</td>
                                <td>%</td>
                                <td>Drug</td>
                                <td>RE</td>
                                <td>Time: <input type="time" name="iopTime"></td>
                                <td>Contact <input type="checkbox" name="iopContact"> Non Contact <input type="checkbox" name="iopNonContact"></td>
                            </tr>
                            <tr>
                                <td>RE LE</td>
                                <td><input type="text" name="mydriasisPercent"></td>
                                <td><input type="text" name="mydriasisDrug"></td>
                                <td>LE</td>
                                <td><input type="text" name="leIOP"></td>
                                <td><input type="text" name="iopMethod"></td>
                            </tr>
                        </table>
                    </div>

                    <!-- IT Fields Section -->
                    <div class="gos18-section">
                        <div class="gos18-section-title">IT Fields / Provisional Diagnosis</div>
                        <table>
                            <tr>
                                <td><strong>Imaging:</strong></td>
                                <td colspan="5">
                                    <input type="checkbox" name="imaging1"> Enclosed
                                    <input type="checkbox" name="imaging2"> Emailed
                                    <input type="checkbox" name="imaging3"> Sent with patient
                                </td>
                            </tr>
                            <tr>
                                <td colspan="6">
                                    <strong>Salient Symptoms, Signs, History, Clinical Findings, Reason for Referral and Provisional Diagnosis:</strong><br>
                                    <textarea name="clinicalFindings" rows="4" style="width: 100%;" id="gos18-clinical-findings"></textarea>
                                </td>
                            </tr>
                        </table>
                    </div>

                    <!-- Referral Section -->
                    <div class="gos18-section">
                        <div class="gos18-section-title">Referral</div>
                        <table>
                            <tr>
                                <td colspan="6">
                                    <div class="gos18-checkbox-group">
                                        <div class="gos18-checkbox-item">
                                            <input type="checkbox" name="referralHES" id="referralHES"> 
                                            <label for="referralHES">HES</label>
                                        </div>
                                        <div class="gos18-checkbox-item">
                                            <input type="checkbox" name="referralOcular" id="referralOcular"> 
                                            <label for="referralOcular">Ocular Emergency - to Hospital A&E Eye Service</label>
                                        </div>
                                        <div class="gos18-checkbox-item">
                                            <input type="checkbox" name="referralSemi" id="referralSemi"> 
                                            <label for="referralSemi">Semi-Urgent - to HES within 4 weeks</label>
                                        </div>
                                        <div class="gos18-checkbox-item">
                                            <input type="checkbox" name="referralRoutine" id="referralRoutine"> 
                                            <label for="referralRoutine">Routine - to HES within 12 weeks</label>
                                        </div>
                                    </div>
                                    
                                    <strong>Supervised by:</strong><br>
                                    <div class="gos18-checkbox-group">
                                        <div class="gos18-checkbox-item">
                                            <input type="checkbox" name="supervisedCataract"> 
                                            <label>Cataract</label>
                                        </div>
                                        <div class="gos18-checkbox-item">
                                            <input type="checkbox" name="supervisedGeneral"> 
                                            <label>General (Medical/Ophthalmology)</label>
                                        </div>
                                        <div class="gos18-checkbox-item">
                                            <input type="checkbox" name="supervisedDiabetic"> 
                                            <label>Diabetic/Dis/Adv</label>
                                        </div>
                                        <div class="gos18-checkbox-item">
                                            <input type="checkbox" name="supervisedLow"> 
                                            <label>Low Vision</label>
                                        </div>
                                        <div class="gos18-checkbox-item">
                                            <input type="checkbox" name="supervisedOther"> 
                                            <label>Other Medical Retinal</label>
                                        </div>
                                        <div class="gos18-checkbox-item">
                                            <input type="checkbox" name="supervisedGlaucoma"> 
                                            <label>Glaucoma</label>
                                        </div>
                                        <div class="gos18-checkbox-item">
                                            <input type="checkbox" name="supervisedSquint"> 
                                            <label>Squint/Ocular Motility</label>
                                        </div>
                                        <div class="gos18-checkbox-item">
                                            <input type="checkbox" name="supervisedYAG"> 
                                            <label>YAG Laser</label>
                                        </div>
                                        <div class="gos18-checkbox-item">
                                            <input type="checkbox" name="supervisedAdnexal"> 
                                            <label>Paed: Adnexal/Orbits</label>
                                        </div>
                                        <div class="gos18-checkbox-item">
                                            <input type="checkbox" name="supervisedExternal"> 
                                            <label>External Eye/Adnexa</label>
                                        </div>
                                        <div class="gos18-checkbox-item">
                                            <input type="checkbox" name="supervisedOrtho"> 
                                            <label>Orthoptics</label>
                                        </div>
                                        <div class="gos18-checkbox-item">
                                            <input type="checkbox" name="supervisedMacular"> 
                                            <label>Macular/Intravitreal</label>
                                        </div>
                                        <div class="gos18-checkbox-item">
                                            <input type="checkbox" name="supervisedPaed"> 
                                            <label>Paed: General/Refrac</label>
                                        </div>
                                    </div>
                                    
                                    <div style="margin-top: 0.5rem;">
                                        <strong>Not otherwise specified:</strong> 
                                        <input type="text" name="notSpecified" style="width: 50%;">
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td colspan="6">
                                    <div class="gos18-checkbox-group" style="margin-top: 1rem;">
                                        <div class="gos18-checkbox-item">
                                            <input type="checkbox" name="referralGP"> 
                                            <label>GP (For Systemic management or appropriate)</label>
                                        </div>
                                        <div class="gos18-checkbox-item">
                                            <input type="checkbox" name="referralNotification"> 
                                            <label>Notification Only</label>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        </table>
                    </div>

                    <!-- Optometrist Details Section -->
                    <div class="gos18-section">
                        <div class="gos18-section-title">Optometrist Name / Date</div>
                        <table>
                            <tr>
                                <td><strong>Signature:</strong></td>
                                <td><input type="text" name="optSignature" placeholder="Type name"></td>
                                <td><strong>GOC No:</strong></td>
                                <td><input type="text" name="gocNumber"></td>
                                <td><strong>Date:</strong></td>
                                <td><input type="date" name="referralDate" id="referralDate"></td>
                            </tr>
                        </table>
                    </div>

                    <!-- Footer Note -->
                    <div class="gos18-section">
                        <p style="font-size: 0.75rem; text-align: center; color: #6b7280;">
                            Please obtain consent from the patient if not already given, and provide feedback to the referring optometrist Referral Letter:<br>
                            <input type="checkbox" name="patientCopy"> Patient Copy
                            <input type="checkbox" name="postedToGP"> Posted to GP
                            <input type="checkbox" name="handedToPatient"> Handed to Pt to take to GP/HES
                            <input type="checkbox" name="faxedToHES"> Faxed to HES<br>
                            GOS018 Unrelated Excel.xlsx
                        </p>
                    </div>
                </form>

                <div class="gos18-actions">
                    <button type="button" class="gos18-button gos18-download" onclick="downloadGOS18()">
                        <svg class="icon" viewBox="0 0 24 24" style="display: inline-block; margin-right: 0.5rem;">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7 10 12 15 17 10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                        Download PDF
                    </button>
                    <button type="button" class="gos18-button gos18-email" onclick="emailGOS18()">
                        <svg class="icon" viewBox="0 0 24 24" style="display: inline-block; margin-right: 0.5rem;">
                            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                            <polyline points="22,6 12,13 2,6"></polyline>
                        </svg>
                        Email Form
                    </button>
                </div>
            </div>

                <div class="action-buttons">
                    <button class="secondary-button" onclick="startOver()">New Assessment</button>
                    <button class="primary-button" onclick="window.print()">Generate Referral Letter</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Application state
        let currentStep = 'welcome';
        let selectedCondition = null;
        let responses = {};
        let currentQuestionIndex = 0;
        let assessmentPath = [];
        let recommendation = null;
        let questionHistory = [];

        // Severity scoring system
        const severityScoring = {
            "Red Eye": {
                "vision": { "Normal vision": 0, "Mild blur": 2, "Significant vision loss": 5 },
                "pain": { "No pain": 0, "Mild discomfort": 1, "Severe pain with photophobia": 4 },
                "discharge": { "No discharge": 0, "Watery discharge": 1, "Mucopurulent discharge": 2 }
            },
            "Flashes & Floaters": {
                "onset": { "Within 24 hours": 5, "Within 1 week": 3, "Within 1 month": 2, "Over 1 month ago": 1 },
                "field": { "Yes - progressive": 5, "Yes - stable": 3, "No": 0 },
                "floaters": { "Yes - shower of floaters": 5, "Yes - few new floaters": 3, "No change": 1 }
            },
            "Sudden Vision Loss": {
                "laterality": { "One eye": 3, "Both eyes": 4 },
                "speed": { "Sudden (seconds)": 5, "Rapid (minutes)": 4, "Gradual (hours)": 2 },
                "pain": { "No pain": 1, "Mild pain": 2, "Severe pain": 4, "Headache with jaw claudication": 5 }
            },
            "Raised IOP": {
                "level": { "21-30 mmHg": 2, "31-40 mmHg": 4, ">40 mmHg": 5 },
                "symptoms": { "No symptoms": 0, "Mild headache": 2, "Severe pain + nausea": 5 }
            },
            "Eyelid Problems": {
                "type": { "Swelling": 3, "Malposition": 1, "Lump/lesion": 3, "Redness": 2 },
                "systemic": { "None": 0, "Mild malaise": 2, "Fever": 4, "Very unwell": 5 }
            },
            "Watery Eyes": {
                "laterality": { "One eye": 3, "Both eyes": 1 },
                "triggers": { "Constant": 3, "Outdoors/wind": 1, "Reading": 2 }
            },
            "Pediatric Eye Problems": {
                "age": { "0-6 months": 4, "6-12 months": 3, "1-3 years": 2, ">3 years": 1 },
                "reflex": { "Normal": 0, "Absent/white": 5, "Not checked": 2 }
            },
            "Diplopia": {
                "type": { "Resolves covering one eye": 3, "Persists with one eye": 1, "Variable": 2 },
                "onset": { "Sudden": 5, "Gradual": 3, "Long-standing": 1 }
            },
            "Headaches with Visual Symptoms": {
                "pattern": { "Zigzag lines": 1, "Vision loss": 3, "Double vision": 4 },
                "fundus": { "Normal": 0, "Disc swelling": 5, "Not examined": 2 }
            },
            "Corneal Problems": {
                "cause": { "Trauma": 3, "Contact lens related": 4, "No specific cause": 1 },
                "staining": { "No staining": 0, "Punctate": 2, "Dendritic": 5, "Large defect": 4, "Not tested": 1 }
            }
        };

        // Medication protocols
        const medicationProtocols = {
            "Red Eye": {
                "emergency": {
                    medications: ["No topical treatment before specialist review", "Oral analgesia if required"],
                    notes: "Avoid topical steroids without specialist guidance"
                },
                "urgent": {
                    medications: ["Cyclopentolate 1% BD (if anterior uveitis)", "Consider oral NSAIDs"],
                    notes: "NO steroids without specialist review"
                },
                "routine": {
                    medications: ["Chloramphenicol 1% QDS 7 days", "Preservative-free lubricants QDS"],
                    notes: "Review if no improvement in 48-72 hours"
                }
            },
            "Flashes & Floaters": {
                "emergency": {
                    medications: ["No specific medications", "Avoid aspirin pre-operatively"],
                    notes: "Surgical management likely required"
                },
                "urgent": {
                    medications: ["No routine medications needed"],
                    notes: "Treatment depends on findings"
                },
                "routine": {
                    medications: ["No medications required"],
                    notes: "Reassurance and monitoring"
                }
            },
            "Sudden Vision Loss": {
                "emergency": {
                    medications: [
                        "Prednisolone 60-80mg PO STAT (if GCA)",
                        "Aspirin 300mg PO STAT (if embolic)",
                        "Consider IV methylpred if optic neuritis"
                    ],
                    notes: "Do NOT delay steroids for tests if GCA suspected"
                },
                "urgent": {
                    medications: [
                        "Aspirin 300mg then 75mg daily",
                        "Statin if not contraindicated",
                        "Antihypertensives as needed"
                    ],
                    notes: "Full vascular risk management"
                },
                "routine": {
                    medications: [
                        "Optimize existing medications",
                        "Consider aspirin if vascular risk"
                    ],
                    notes: "Focus on risk factor modification"
                }
            },
            "Raised IOP": {
                "emergency": {
                    medications: [
                        "Acetazolamide 500mg PO STAT then 250mg QDS",
                        "Timolol 0.5% STAT",
                        "Brimonidine 0.2% STAT",
                        "Pilocarpine 2% QDS"
                    ],
                    notes: "IV acetazolamide if vomiting"
                },
                "urgent": {
                    medications: [
                        "Timolol 0.5% BD",
                        "Consider oral acetazolamide"
                    ],
                    notes: "Start treatment while awaiting review"
                },
                "routine": {
                    medications: ["Consider topical therapy based on risk"],
                    notes: "Treatment decision after full assessment"
                }
            },
            "Corneal Problems": {
                "emergency": {
                    medications: ["Intensive fortified antibiotics as per protocol"],
                    notes: "NO treatment until after corneal scrape"
                },
                "urgent": {
                    medications: [
                        "Aciclovir 3% ointment 5x daily (if HSV)",
                        "Chloramphenicol 1% QDS (if bacterial)"
                    ],
                    notes: "Stop contact lens wear immediately"
                },
                "routine": {
                    medications: ["Chloramphenicol 1% QDS 5-7 days"],
                    notes: "Simple abrasions heal quickly"
                }
            }
        };

        // Safety netting configuration
        const safetyNettingConfig = {
            "Red Eye": {
                "emergency": [
                    "Return IMMEDIATELY if vision deteriorates",
                    "Seek urgent care if pain increases dramatically",
                    "Do not use any eye drops unless prescribed",
                    "Keep emergency eye department contact details"
                ],
                "urgent": [
                    "Return if symptoms worsen or no improvement in 24 hours",
                    "Avoid driving if vision affected",
                    "Use prescribed medications as directed",
                    "Attend all follow-up appointments"
                ],
                "routine": [
                    "Return if no improvement in 48-72 hours",
                    "Complete full course of antibiotics",
                    "Maintain good hygiene",
                    "Avoid sharing towels/pillows"
                ]
            },
            "Flashes & Floaters": {
                "emergency": [
                    "Return IMMEDIATELY if curtain/shadow develops in vision",
                    "Seek urgent care if sudden shower of new floaters",
                    "Call 999 if sudden complete vision loss",
                    "Keep mobile phone charged and accessible"
                ],
                "urgent": [
                    "Return urgently if visual field defect develops",
                    "Monitor for increasing floaters or flashes",
                    "Avoid heavy lifting/straining until reviewed",
                    "Have someone available to drive if vision deteriorates"
                ],
                "routine": [
                    "Annual dilated examination if high myope",
                    "Return if symptoms change or worsen",
                    "Maintain regular eye examinations",
                    "Report any new visual symptoms promptly"
                ]
            },
            "Sudden Vision Loss": {
                "emergency": [
                    "Take prescribed steroids EXACTLY as directed (if GCA)",
                    "Do NOT stop steroids without medical advice",
                    "Return IMMEDIATELY if vision worsens or other eye affected",
                    "Keep emergency contact numbers readily available"
                ],
                "urgent": [
                    "Monitor for vision changes in either eye",
                    "Take aspirin as prescribed (if vascular cause)",
                    "Attend all follow-up appointments",
                    "Control vascular risk factors strictly"
                ],
                "routine": [
                    "Regular monitoring of vision",
                    "Optimize cardiovascular risk factors",
                    "Report any new symptoms immediately",
                    "Maintain prescribed medications"
                ]
            }
        };

        // Clinical notes templates for GOS18
        const clinicalNotesTemplates = {
            "Red Eye": {
                "emergency": (responses) => 
                    `URGENT: ${responses.laterality} red eye with ${responses.vision}. 
                    ${responses.pain === 'Severe pain with photophobia' ? 'Severe photophobia present. ' : ''}
                    ${responses.discharge}. Requires immediate assessment to exclude sight-threatening pathology.`,
                
                "urgent": (responses) => 
                    `${responses.laterality} red eye, ${responses.pain}. Vision: ${responses.vision}. 
                    ${responses.discharge}. Clinical features suggest inflammatory/infective cause requiring prompt treatment.`,
                
                "routine": (responses) => 
                    `${responses.laterality} red eye, likely ${responses.discharge === 'Mucopurulent discharge' ? 'bacterial conjunctivitis' : 'viral/allergic'}. 
                    Vision: ${responses.vision}. Conservative management initiated.`
            },
            "Flashes & Floaters": {
                "emergency": (responses) => 
                    `URGENT: ${responses.floaters === 'Yes - shower of floaters' ? 'Shower of new floaters' : 'Acute symptoms'} 
                    with ${responses.field === 'Yes - progressive' ? 'PROGRESSIVE FIELD DEFECT - ?RD. ' : ''}
                    Onset ${responses.onset}. Requires immediate dilated retinal examination to exclude retinal tear/detachment.`,
                
                "urgent": (responses) => 
                    `Recent onset flashes and floaters, started ${responses.onset}. 
                    No field defect currently. Requires dilated peripheral retinal examination within 48 hours 
                    to exclude retinal tear. Patient counselled re RD symptoms.`,
                
                "routine": (responses) => 
                    `Chronic floaters ${responses.onset}. No recent change. 
                    Vision stable. No field defect. 
                    Likely benign PVD but requires confirmation with dilated examination.`
            },
            "Sudden Vision Loss": {
                "emergency": (responses) => 
                    `EMERGENCY: Sudden ${responses.laterality} vision loss. 
                    ${responses.pain === 'Headache with jaw claudication' ? 'GCA SYMPTOMS - STARTED HIGH-DOSE STEROIDS. ' : ''}
                    Onset ${responses.speed}. Requires immediate assessment and treatment.`,
                
                "urgent": (responses) => 
                    `Acute ${responses.laterality} visual disturbance. 
                    Onset ${responses.speed}. ${responses.pain}. 
                    Requires urgent assessment for cause.`,
                
                "routine": (responses) => 
                    `${responses.speed} vision loss, ${responses.laterality}. 
                    No acute features. 
                    Requires ophthalmology assessment to determine cause and optimize management.`
            }
        };

        // Clinical data structure with questions and logic for each condition
        const clinicalData = {
            "Red Eye": {
                description: "Comprehensive assessment for red eye presentations including infection, inflammation, and sight-threatening conditions",
                pathways: ["Unilateral", "Bilateral", "Contact lens-related", "Post-operative"],
                redFlags: [
                    "Recent cataract surgery or intravitreal injection (last 4 weeks)",
                    "Severe headache with vomiting",
                    "Pain waking patient at night",
                    "Reduced vision",
                    "Contact lens wearer with symptoms"
                ],
                questions: [
                    {
                        id: "laterality",
                        text: "Is the red eye unilateral or bilateral?",
                        options: ["Unilateral", "Bilateral"],
                        clinicalNote: "Bilateral red eye often suggests allergic or infective causes"
                    },
                    {
                        id: "vision",
                        text: "Is vision affected?",
                        options: ["Normal vision", "Mild blur", "Significant vision loss"],
                        clinicalNote: "Vision loss with red eye requires urgent assessment"
                    },
                    {
                        id: "pain",
                        text: "What is the severity of pain?",
                        options: ["No pain", "Mild discomfort", "Severe pain with photophobia"],
                        clinicalNote: "Severe pain suggests serious pathology"
                    },
                    {
                        id: "discharge",
                        text: "Is there discharge present?",
                        options: ["No discharge", "Watery discharge", "Mucopurulent discharge"],
                        clinicalNote: "Type of discharge helps differentiate causes"
                    }
                ],
                recommendations: {
                    urgent: {
                        criteria: ["vision:Significant vision loss", "pain:Severe pain with photophobia"],
                        condition: "Possible uveitis, keratitis, or acute glaucoma",
                        management: "Same-day ophthalmology referral required"
                    },
                    routine: {
                        criteria: ["discharge:Mucopurulent discharge", "vision:Normal vision"],
                        condition: "Likely bacterial conjunctivitis",
                        management: "Chloramphenicol QDS 7 days, review if no improvement"
                    }
                }
            },
            "Flashes & Floaters": {
                description: "Assessment for posterior vitreous detachment and retinal pathology",
                pathways: ["Acute onset", "Chronic symptoms", "High-risk features"],
                redFlags: [
                    "Shower of floaters/cobwebs",
                    "Progressive visual field loss",
                    "Curtain/shadow in vision",
                    "Recent onset arc-like flashes"
                ],
                questions: [
                    {
                        id: "onset",
                        text: "When did symptoms begin?",
                        options: ["Within 24 hours", "Within 1 week", "Within 1 month", "Over 1 month ago"],
                        clinicalNote: "Acute onset requires urgent assessment"
                    },
                    {
                        id: "field",
                        text: "Any visual field loss?",
                        options: ["Yes - progressive", "Yes - stable", "No"],
                        clinicalNote: "Progressive field loss indicates retinal detachment"
                    },
                    {
                        id: "floaters",
                        text: "Have floaters increased?",
                        options: ["Yes - shower of floaters", "Yes - few new floaters", "No change"],
                        clinicalNote: "Shower of floaters suggests vitreous hemorrhage"
                    }
                ],
                recommendations: {
                    emergency: {
                        criteria: ["field:Yes - progressive"],
                        condition: "Probable retinal detachment",
                        management: "IMMEDIATE ophthalmology referral - same day"
                    },
                    urgent: {
                        criteria: ["onset:Within 24 hours", "floaters:Yes - shower of floaters"],
                        condition: "Acute PVD with high risk of tear",
                        management: "Urgent dilated examination within 24-48 hours"
                    },
                    routine: {
                        criteria: ["onset:Over 1 month ago", "field:No"],
                        condition: "Chronic floaters - likely benign",
                        management: "Routine referral if symptomatic"
                    }
                }
            },
            "Sudden Vision Loss": {
                description: "Rapid assessment for acute vision loss - time-critical pathology",
                pathways: ["Vascular", "Inflammatory", "Retinal", "Neurological"],
                redFlags: [
                    "Complete vision loss",
                    "Giant cell arteritis symptoms",
                    "RAPD present",
                    "Cherry red spot"
                ],
                questions: [
                    {
                        id: "laterality",
                        text: "Which eye(s) affected?",
                        options: ["One eye", "Both eyes"],
                        clinicalNote: "Bilateral suggests neurological cause"
                    },
                    {
                        id: "speed",
                        text: "Speed of vision loss?",
                        options: ["Sudden (seconds)", "Rapid (minutes)", "Gradual (hours)"],
                        clinicalNote: "Instantaneous suggests vascular occlusion"
                    },
                    {
                        id: "pain",
                        text: "Is there pain?",
                        options: ["No pain", "Mild pain", "Severe pain", "Headache with jaw claudication"],
                        clinicalNote: "Painless loss often vascular; jaw claudication = GCA"
                    }
                ],
                recommendations: {
                    emergency: {
                        criteria: ["pain:Headache with jaw claudication"],
                        condition: "Giant cell arteritis suspected",
                        management: "START PREDNISOLONE 60-80mg IMMEDIATELY, urgent ESR/CRP"
                    },
                    urgent: {
                        criteria: ["speed:Sudden (seconds)", "pain:No pain"],
                        condition: "Possible CRAO or CRVO",
                        management: "IMMEDIATE ophthalmology assessment required"
                    }
                }
            },
            "Raised IOP": {
                description: "Management pathway for elevated intraocular pressure",
                pathways: ["Acute symptomatic", "Chronic asymptomatic", "Steroid-induced"],
                redFlags: [
                    "IOP >35 mmHg",
                    "Corneal edema",
                    "Fixed dilated pupil",
                    "Severe pain with nausea"
                ],
                questions: [
                    {
                        id: "level",
                        text: "What is the IOP level?",
                        options: ["21-30 mmHg", "31-40 mmHg", ">40 mmHg"],
                        clinicalNote: "Higher levels require more urgent management"
                    },
                    {
                        id: "symptoms",
                        text: "Are there symptoms?",
                        options: ["No symptoms", "Mild headache", "Severe pain + nausea"],
                        clinicalNote: "Symptoms suggest acute angle closure"
                    }
                ],
                recommendations: {
                    emergency: {
                        criteria: ["symptoms:Severe pain + nausea"],
                        condition: "Acute angle closure glaucoma",
                        management: "IMMEDIATE referral, start acetazolamide"
                    },
                    routine: {
                        criteria: ["symptoms:No symptoms", "level:21-30 mmHg"],
                        condition: "Ocular hypertension",
                        management: "Routine glaucoma assessment"
                    }
                }
            },
            "Eyelid Problems": {
                description: "Assessment for lid malposition, infection, and malignancy",
                pathways: ["Infectious", "Mechanical", "Neoplastic", "Inflammatory"],
                redFlags: [
                    "Orbital signs (proptosis, restricted movements)",
                    "Systemically unwell with lid swelling",
                    "Loss of eyelashes",
                    "Ulcerating lesion"
                ],
                questions: [
                    {
                        id: "type",
                        text: "What is the primary problem?",
                        options: ["Swelling", "Malposition", "Lump/lesion", "Redness"],
                        clinicalNote: "Different pathways for each type"
                    },
                    {
                        id: "systemic",
                        text: "Any systemic features?",
                        options: ["None", "Mild malaise", "Fever", "Very unwell"],
                        clinicalNote: "Systemic features may indicate orbital cellulitis"
                    }
                ],
                recommendations: {
                    emergency: {
                        criteria: ["systemic:Very unwell"],
                        condition: "Possible orbital cellulitis",
                        management: "ADMIT for IV antibiotics"
                    },
                    routine: {
                        criteria: ["type:Lump/lesion", "systemic:None"],
                        condition: "Benign lid lesion likely",
                        management: "Routine oculoplastics referral"
                    }
                }
            },
            "Watery Eyes": {
                description: "Evaluation of epiphora - distinguishing reflex from obstructive causes",
                pathways: ["Reflex tearing", "Lacrimal obstruction", "Lid malposition"],
                redFlags: [
                    "Associated with lid swelling",
                    "Bloody tears",
                    "Recurrent infections"
                ],
                questions: [
                    {
                        id: "laterality",
                        text: "Which eye(s) affected?",
                        options: ["One eye", "Both eyes"],
                        clinicalNote: "Unilateral suggests obstruction"
                    },
                    {
                        id: "triggers",
                        text: "When is watering worst?",
                        options: ["Constant", "Outdoors/wind", "Reading"],
                        clinicalNote: "Environmental triggers suggest reflex tearing"
                    }
                ],
                recommendations: {
                    routine: {
                        criteria: ["laterality:One eye", "triggers:Constant"],
                        condition: "Likely nasolacrimal obstruction",
                        management: "Routine lacrimal clinic referral"
                    }
                }
            },
            "Pediatric Eye Problems": {
                description: "Age-appropriate assessment for children's eye conditions",
                pathways: ["Infant (<1yr)", "Toddler (1-3yr)", "School age (4-10yr)"],
                redFlags: [
                    "White pupil (leukocoria)",
                    "Cloudy cornea",
                    "Nystagmus",
                    "Not fixing/following by 3 months"
                ],
                questions: [
                    {
                        id: "age",
                        text: "What is the child's age?",
                        options: ["0-6 months", "6-12 months", "1-3 years", ">3 years"],
                        clinicalNote: "Age determines urgency"
                    },
                    {
                        id: "reflex",
                        text: "Is red reflex normal?",
                        options: ["Normal", "Absent/white", "Not checked"],
                        clinicalNote: "Abnormal reflex requires URGENT referral"
                    }
                ],
                recommendations: {
                    emergency: {
                        criteria: ["reflex:Absent/white"],
                        condition: "Leukocoria - ?retinoblastoma",
                        management: "URGENT pediatric ophthalmology within 2 weeks"
                    }
                }
            },
            "Diplopia": {
                description: "Double vision assessment - distinguishing neurological from mechanical causes",
                pathways: ["Monocular", "Binocular", "Variable"],
                redFlags: [
                    "Pupil involvement (CN III)",
                    "Multiple cranial nerves",
                    "Progressive symptoms"
                ],
                questions: [
                    {
                        id: "type",
                        text: "Is diplopia monocular or binocular?",
                        options: ["Resolves covering one eye", "Persists with one eye", "Variable"],
                        clinicalNote: "Monocular is usually refractive"
                    },
                    {
                        id: "onset",
                        text: "How did it start?",
                        options: ["Sudden", "Gradual", "Long-standing"],
                        clinicalNote: "Sudden onset needs urgent assessment"
                    }
                ],
                recommendations: {
                    urgent: {
                        criteria: ["type:Resolves covering one eye", "onset:Sudden"],
                        condition: "Acute cranial nerve palsy",
                        management: "Urgent neuro-ophthalmology assessment"
                    }
                }
            },
            "Headaches with Visual Symptoms": {
                description: "Differentiating primary headaches from sight/life-threatening causes",
                pathways: ["Migraine", "Raised ICP", "Vascular", "Ocular"],
                redFlags: [
                    "Papilledema",
                    "New headache pattern >50 years",
                    "Worse on waking/valsalva"
                ],
                questions: [
                    {
                        id: "pattern",
                        text: "What visual symptoms occur?",
                        options: ["Zigzag lines", "Vision loss", "Double vision"],
                        clinicalNote: "Pattern helps differentiate causes"
                    },
                    {
                        id: "fundus",
                        text: "Fundus examination findings?",
                        options: ["Normal", "Disc swelling", "Not examined"],
                        clinicalNote: "Papilledema requires urgent investigation"
                    }
                ],
                recommendations: {
                    emergency: {
                        criteria: ["fundus:Disc swelling"],
                        condition: "Papilledema - raised ICP",
                        management: "URGENT medical admission for imaging"
                    }
                }
            },
            "Corneal Problems": {
                description: "Assessment of corneal pathology including trauma, infection, and dystrophies",
                pathways: ["Traumatic", "Infectious", "Inflammatory", "Degenerative"],
                redFlags: [
                    "Contact lens wearer with pain",
                    "Penetrating injury suspicion",
                    "Dendritic ulcer pattern"
                ],
                questions: [
                    {
                        id: "cause",
                        text: "What is the likely cause?",
                        options: ["Trauma", "Contact lens related", "No specific cause"],
                        clinicalNote: "CL keratitis needs different management"
                    },
                    {
                        id: "staining",
                        text: "Fluorescein staining pattern?",
                        options: ["No staining", "Punctate", "Dendritic", "Large defect", "Not tested"],
                        clinicalNote: "Dendritic = HSV, needs antivirals"
                    }
                ],
                recommendations: {
                    urgent: {
                        criteria: ["staining:Dendritic"],
                        condition: "Herpetic keratitis",
                        management: "Same-day ophthalmology, start aciclovir"
                    },
                    emergency: {
                        criteria: ["cause:Contact lens related", "staining:Large defect"],
                        condition: "Contact lens keratitis",
                        management: "Stop CL wear, same-day referral"
                    }
                }
            }
        };

        // Function to calculate severity score
        function calculateSeverityScore(condition, responses) {
            let totalScore = 0;
            const scoring = severityScoring[condition];
            
            if (!scoring) return 0;
            
            Object.entries(responses).forEach(([questionId, answer]) => {
                if (scoring[questionId] && scoring[questionId][answer] !== undefined) {
                    totalScore += scoring[questionId][answer];
                }
            });
            
            return totalScore;
        }

        // Function to generate clinical notes for GOS18
        function generateClinicalNotes(condition, urgency, responses) {
            if (clinicalNotesTemplates[condition] && clinicalNotesTemplates[condition][urgency]) {
                return clinicalNotesTemplates[condition][urgency](responses);
            }
            
            // Fallback for conditions without templates
            let notes = `${condition} - ${urgency} referral. `;
            Object.entries(responses).forEach(([key, value]) => {
                notes += `${key.replace(/_/g, ' ')}: ${value}. `;
            });
            return notes;
        }

        // Function to populate GOS18 form
        function populateGOS18Form() {
            if (!recommendation) return;
            
            // Set clinical findings
            const clinicalFindingsTextarea = document.getElementById('gos18-clinical-findings');
            const clinicalNotes = generateClinicalNotes(selectedCondition, recommendation.urgency, responses);
            if (clinicalFindingsTextarea) {
                clinicalFindingsTextarea.value = clinicalNotes;
            }
            
            // Check appropriate urgency box
            const urgencyCheckboxes = {
                'emergency': document.getElementById('referralOcular'),
                'urgent': document.getElementById('referralSemi'),
                'routine': document.getElementById('referralRoutine')
            };
            
            const urgencyCheckbox = urgencyCheckboxes[recommendation.urgency];
            if (urgencyCheckbox) {
                urgencyCheckbox.checked = true;
            }
            
            // Set today's date
            const referralDateInput = document.getElementById('referralDate');
            if (referralDateInput) {
                referralDateInput.value = new Date().toISOString().split('T')[0];
            }
            
            // Set appropriate subspecialty based on condition
            const subspecialtyMap = {
                "Flashes & Floaters": "supervisedMacular",
                "Sudden Vision Loss": "supervisedGeneral",
                "Red Eye": "supervisedGeneral",
                "Raised IOP": "supervisedGlaucoma",
                "Eyelid Problems": "supervisedAdnexal",
                "Watery Eyes": "supervisedAdnexal",
                "Pediatric Eye Problems": "supervisedPaed",
                "Diplopia": "supervisedSquint",
                "Headaches with Visual Symptoms": "supervisedGeneral",
                "Corneal Problems": "supervisedExternal"
            };
            
            const subspecialtyCheckbox = document.getElementsByName(subspecialtyMap[selectedCondition])[0];
            if (subspecialtyCheckbox) {
                subspecialtyCheckbox.checked = true;
            }
        }

        // Function to toggle GOS18 form
        function toggleGOS18Form() {
            const container = document.getElementById('gos18-form-container');
            container.classList.toggle('hidden');
            
            // Populate the form when opened
            if (!container.classList.contains('hidden')) {
                populateGOS18Form();
            }
        }

        // Function to hide GOS18 form
        function hideGOS18Form() {
            const container = document.getElementById('gos18-form-container');
            container.classList.add('hidden');
        }

        // Function to download GOS18 as PDF
        async function downloadGOS18() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();
            
            // Get form data
            const formData = new FormData(document.getElementById('gos18-form'));
            
            // Add title
            pdf.setFontSize(16);
            pdf.text('GOS 18 - Referral/Notification', 20, 20);
            
            // Add assessment summary
            pdf.setFontSize(12);
            pdf.text(`Condition: ${selectedCondition}`, 20, 35);
            pdf.text(`Urgency: ${recommendation.urgency.toUpperCase()}`, 20, 45);
            pdf.text(`Severity Score: ${recommendation.severityScore || 'N/A'}`, 20, 55);
            
            // Add form content
            let yPosition = 70;
            const lineHeight = 10;
            
            pdf.setFontSize(10);
            
            // Iterate through form data
            for (let [key, value] of formData.entries()) {
                if (value && value !== '') {
                    // Format the key nicely
                    const formattedKey = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                    
                    // Handle long text
                    if (value.length > 60) {
                        const lines = pdf.splitTextToSize(`${formattedKey}: ${value}`, 170);
                        lines.forEach(line => {
                            if (yPosition > 280) {
                                pdf.addPage();
                                yPosition = 20;
                            }
                            pdf.text(line, 20, yPosition);
                            yPosition += lineHeight;
                        });
                    } else {
                        pdf.text(`${formattedKey}: ${value}`, 20, yPosition);
                        yPosition += lineHeight;
                    }
                    
                    if (yPosition > 280) {
                        pdf.addPage();
                        yPosition = 20;
                    }
                }
            }
            
            // Save the PDF
            pdf.save(`GOS18_${selectedCondition.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        // Function to email GOS18 form
        function emailGOS18() {
            const formData = new FormData(document.getElementById('gos18-form'));
            let emailBody = 'GOS 18 - Referral/Notification\n\n';
            emailBody += `Condition: ${selectedCondition}\n`;
            emailBody += `Urgency: ${recommendation.urgency.toUpperCase()}\n`;
            emailBody += `Severity Score: ${recommendation.severityScore || 'N/A'}\n\n`;
            
            // Add assessment summary
            emailBody += 'ASSESSMENT SUMMARY:\n';
            assessmentPath.forEach(step => {
                emailBody += `${step.question}: ${step.answer}\n`;
            });
            emailBody += '\n';
            
            // Add form data
            emailBody += 'REFERRAL DETAILS:\n';
            for (let [key, value] of formData.entries()) {
                if (value && value !== '') {
                    const formattedKey = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                    emailBody += `${formattedKey}: ${value}\n`;
                }
            }
            
            // Create mailto link
            const subject = `GOS18 Referral - ${selectedCondition} - ${recommendation.urgency.toUpperCase()}`;
            const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailBody)}`;
            
            // Open email client
            window.location.href = mailtoLink;
        }

        // Function to display conditions
        function displayConditions() {
            const conditionGrid = document.getElementById('condition-grid');
            conditionGrid.innerHTML = '';
            
            Object.keys(clinicalData).forEach(conditionName => {
                const condition = clinicalData[conditionName];
                const card = document.createElement('button');
                card.className = 'condition-card';
                card.onclick = () => selectCondition(conditionName);
                
                card.innerHTML = `
                    <div class="condition-header">
                        <h3 class="condition-title">${conditionName}</h3>
                        <svg class="icon" viewBox="0 0 24 24" style="opacity: 0.5;">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </div>
                    <p class="condition-description">${condition.description}</p>
                    <p class="condition-pathways">Pathways: ${condition.pathways.join(', ')}</p>
                `;
                
                conditionGrid.appendChild(card);
            });
        }

        // Function to select condition and start assessment
        function selectCondition(conditionName) {
            selectedCondition = conditionName;
            currentQuestionIndex = 0;
            responses = {};
            assessmentPath = [];
            questionHistory = [];
            
            document.getElementById('welcome-screen').classList.add('hidden');
            document.getElementById('assessment-screen').classList.remove('hidden');
            document.getElementById('assessment-subtitle').textContent = `${conditionName} Assessment`;
            
            displayRedFlags();
            displayQuestion();
        }

        // Function to display red flags
        function displayRedFlags() {
            const redFlagsBox = document.getElementById('red-flags-box');
            const redFlagsList = document.getElementById('red-flags-list');
            const condition = clinicalData[selectedCondition];
            
            if (condition.redFlags && condition.redFlags.length > 0) {
                redFlagsBox.classList.remove('hidden');
                redFlagsList.innerHTML = '';
                
                condition.redFlags.forEach(flag => {
                    const li = document.createElement('li');
                    li.className = 'red-flag-item';
                    li.innerHTML = `
                        <svg class="icon" viewBox="0 0 24 24" style="width: 16px; height: 16px; flex-shrink: 0;">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="8" x2="12" y2="12"></line>
                            <line x1="12" y1="16" x2="12.01" y2="16"></line>
                        </svg>
                        ${flag}
                    `;
                    redFlagsList.appendChild(li);
                });
            } else {
                redFlagsBox.classList.add('hidden');
            }
        }

        // Function to display current question
        function displayQuestion() {
            const condition = clinicalData[selectedCondition];
            const questions = condition.questions;
            
            if (currentQuestionIndex >= questions.length) {
                generateRecommendation();
                return;
            }
            
            const question = questions[currentQuestionIndex];
            
            // Update progress
            const progressText = `Question ${currentQuestionIndex + 1} of ${questions.length}`;
            const progressPercent = Math.round((currentQuestionIndex / questions.length) * 100);
            
            document.getElementById('progress-text').textContent = progressText;
            document.getElementById('progress-percent').textContent = `${progressPercent}% Complete`;
            document.getElementById('progress-fill').style.width = `${progressPercent}%`;
            
            // Display question
            document.getElementById('question-title').textContent = question.text;
            
            // Display subtitle if present
            const subtitleElement = document.getElementById('question-subtitle');
            if (question.subtitle) {
                subtitleElement.textContent = question.subtitle;
                subtitleElement.classList.remove('hidden');
            } else {
                subtitleElement.classList.add('hidden');
            }
            
            // Display options
            const optionsContainer = document.getElementById('question-options');
            optionsContainer.innerHTML = '';
            
            const optionsDiv = document.createElement('div');
            optionsDiv.className = 'options-container';
            
            question.options.forEach(option => {
                const button = document.createElement('button');
                button.className = 'option-button';
                button.textContent = option;
                button.onclick = () => selectAnswer(option);
                optionsDiv.appendChild(button);
            });
            
            optionsContainer.appendChild(optionsDiv);
            
            // Display clinical note
            const clinicalNoteElement = document.getElementById('clinical-note');
            if (question.clinicalNote) {
                clinicalNoteElement.textContent = question.clinicalNote;
                clinicalNoteElement.classList.remove('hidden');
            } else {
                clinicalNoteElement.classList.add('hidden');
            }
            
            // Update navigation
            const backButton = document.getElementById('back-button');
            backButton.disabled = questionHistory.length === 0;
        }

        // Function to handle answer selection
        function selectAnswer(answer) {
            const condition = clinicalData[selectedCondition];
            const question = condition.questions[currentQuestionIndex];
            
            // Store response
            responses[question.id] = answer;
            assessmentPath.push({
                question: question.text,
                answer: answer
            });
            
            // Store current index in history
            questionHistory.push(currentQuestionIndex);
            
            // Move to next question
            currentQuestionIndex++;
            displayQuestion();
        }

        // Function to go back to previous question
        function previousQuestion() {
            if (questionHistory.length > 0) {
                currentQuestionIndex = questionHistory.pop();
                const condition = clinicalData[selectedCondition];
                const questionId = condition.questions[currentQuestionIndex].id;
                delete responses[questionId];
                assessmentPath.pop();
                
                displayQuestion();
            }
        }

        // Function to generate recommendation based on responses
        function generateRecommendation() {
            const condition = clinicalData[selectedCondition];
            let urgency = 'routine';
            let matchedRecommendation = null;
            
            // Calculate severity score
            const severityScore = calculateSeverityScore(selectedCondition, responses);
            
            // Check for emergency criteria first
            if (condition.recommendations.emergency) {
                const emergency = condition.recommendations.emergency;
                if (checkCriteria(emergency.criteria)) {
                    urgency = 'emergency';
                    matchedRecommendation = emergency;
                }
            }
            
            // Then check urgent criteria
            if (!matchedRecommendation && condition.recommendations.urgent) {
                const urgent = condition.recommendations.urgent;
                if (checkCriteria(urgent.criteria)) {
                    urgency = 'urgent';
                    matchedRecommendation = urgent;
                }
            }
            
            // Default to routine
            if (!matchedRecommendation && condition.recommendations.routine) {
                matchedRecommendation = condition.recommendations.routine;
            }
            
            // Fallback recommendation
            if (!matchedRecommendation) {
                matchedRecommendation = {
                    condition: `${selectedCondition} requiring assessment`,
                    management: "Clinical assessment recommended based on findings"
                };
            }
            
            recommendation = {
                urgency: urgency,
                condition: matchedRecommendation.condition,
                management: matchedRecommendation.management,
                reasoning: `Based on clinical assessment: ${matchedRecommendation.condition}`,
                severityScore: severityScore
            };
            
            displayResults();
        }

        // Function to check if criteria are met
        function checkCriteria(criteria) {
            if (!criteria) return false;
            
            return criteria.every(criterion => {
                const [questionId, expectedAnswer] = criterion.split(':');
                return responses[questionId] === expectedAnswer;
            });
        }

        // Function to display results
        function displayResults() {
            document.getElementById('assessment-screen').classList.add('hidden');
            document.getElementById('results-screen').classList.remove('hidden');
            
            // Set urgency icon
            const urgencyIcon = document.getElementById('urgency-icon');
            const iconColors = {
                emergency: '#dc2626',
                urgent: '#f59e0b',
                routine: '#10b981'
            };
            
            urgencyIcon.style.backgroundColor = iconColors[recommendation.urgency];
            urgencyIcon.innerHTML = `
                <svg class="icon" viewBox="0 0 24 24">
                    ${recommendation.urgency === 'emergency' ? 
                        '<path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line>' :
                        '<circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line>'}
                </svg>
            `;
            
            // Set recommendation text
            document.getElementById('recommendation-title').textContent = 
                `${recommendation.urgency.charAt(0).toUpperCase() + recommendation.urgency.slice(1)} Referral`;
            document.getElementById('recommendation-subtitle').textContent = recommendation.condition;
            document.getElementById('reasoning-text').textContent = recommendation.reasoning;
            
            // Set severity score
            const severityScore = recommendation.severityScore || 0;
            document.getElementById('severity-score').textContent = `Clinical Severity Score: ${severityScore}`;
            
            // Calculate percentage (assuming max score of 20)
            const severityPercentage = Math.min((severityScore / 20) * 100, 100);
            document.getElementById('severity-fill').style.width = `${severityPercentage}%`;
            
            // Set MECS eligibility
            const mecsDiv = document.getElementById('mecs-eligibility');
            const isEmergency = recommendation.urgency === 'emergency';
            
            if (isEmergency) {
                mecsDiv.innerHTML = `
                    <div class="mecs-not-eligible">
                        <svg class="icon" viewBox="0 0 24 24" style="width: 16px; height: 16px;">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                        NOT MECS ELIGIBLE - Requires secondary care
                    </div>
                `;
            } else {
                mecsDiv.innerHTML = `
                    <div class="mecs-eligible">
                        <svg class="icon" viewBox="0 0 24 24" style="width: 16px; height: 16px;">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                        May be MECS eligible - check local pathway
                    </div>
                `;
            }
            
            // Set next steps
            document.getElementById('next-steps-text').textContent = recommendation.management;
            
            // Set management steps
            const managementList = document.getElementById('immediate-management');
            managementList.innerHTML = '';
            
            const managementSteps = [
                "Document all findings thoroughly",
                "Provide safety-net advice",
                "Arrange appropriate follow-up"
            ];
            
            managementSteps.forEach(step => {
                const li = document.createElement('li');
                li.className = 'management-item';
                li.innerHTML = `
                    <svg class="icon" viewBox="0 0 24 24" style="width: 16px; height: 16px; flex-shrink: 0;">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                    ${step}
                `;
                managementList.appendChild(li);
            });
            
            // Set medications
            const medicationsList = document.getElementById('medications-list');
            const medicationsBox = document.getElementById('medications-box');
            medicationsList.innerHTML = '';
            
            const protocolMedications = medicationProtocols[selectedCondition]?.[recommendation.urgency];
            if (protocolMedications && protocolMedications.medications.length > 0) {
                medicationsBox.style.display = 'block';
                
                protocolMedications.medications.forEach(med => {
                    const li = document.createElement('li');
                    li.className = 'management-item';
                    li.innerHTML = `
                        <svg class="icon" viewBox="0 0 24 24" style="width: 16px; height: 16px; flex-shrink: 0;">
                            <circle cx="12" cy="12" r="3"></circle>
                        </svg>
                        ${med}
                    `;
                    medicationsList.appendChild(li);
                });
                
                // Add notes if present
                if (protocolMedications.notes) {
                    const noteItem = document.createElement('li');
                    noteItem.className = 'management-item';
                    noteItem.style.fontStyle = 'italic';
                    noteItem.style.marginTop = '0.5rem';
                    noteItem.innerHTML = `
                        <svg class="icon" viewBox="0 0 24 24" style="width: 16px; height: 16px; flex-shrink: 0;">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="16" x2="12" y2="12"></line>
                            <line x1="12" y1="8" x2="12.01" y2="8"></line>
                        </svg>
                        ${protocolMedications.notes}
                    `;
                    medicationsList.appendChild(noteItem);
                }
            } else {
                medicationsBox.style.display = 'none';
            }
            
            // Set documentation requirements
            const formsList = document.getElementById('forms-list');
            formsList.innerHTML = '';
            
            const forms = [
                "GOS18 referral form",
                "Clinical findings documentation",
                "Visual acuity recording",
                "Patient information leaflet"
            ];
            
            forms.forEach(form => {
                const li = document.createElement('li');
                li.className = 'forms-item';
                li.innerHTML = `
                    <svg class="icon" viewBox="0 0 24 24" style="width: 16px; height: 16px; flex-shrink: 0;">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                    </svg>
                    ${form}
                `;
                formsList.appendChild(li);
            });
            
            // Set safety-netting advice
            const safetyList = document.getElementById('safety-list');
            safetyList.innerHTML = '';
            
            const safetyAdvice = safetyNettingConfig[selectedCondition]?.[recommendation.urgency] || [
                "Return immediately if symptoms worsen",
                "Seek urgent care if new symptoms develop",
                "Attend all follow-up appointments",
                "Contact emergency services if concerned"
            ];
            
            safetyAdvice.forEach(advice => {
                const li = document.createElement('li');
                li.className = 'safety-item';
                li.innerHTML = `
                    <svg class="icon" viewBox="0 0 24 24" style="width: 16px; height: 16px; flex-shrink: 0;">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                    </svg>
                    ${advice}
                `;
                safetyList.appendChild(li);
            });
            
            window.scrollTo(0, 0);
        }

        // Function to start over
        function startOver() {
            currentStep = 'welcome';
            selectedCondition = null;
            responses = {};
            currentQuestionIndex = 0;
            assessmentPath = [];
            recommendation = null;
            questionHistory = [];
            
            document.getElementById('welcome-screen').classList.remove('hidden');
            document.getElementById('assessment-screen').classList.add('hidden');
            document.getElementById('results-screen').classList.add('hidden');
            
            window.scrollTo(0, 0);
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            displayConditions();
        });
    </script>
</body>
</html>
